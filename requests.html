<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>CCC Request Form</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- Bootstrap Date/Time Picker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/css/tempusdominus-bootstrap-4.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Editable CSS -->
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" /> <!-- Custom CSS -->
    <!-- jQuery Toast -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        .jsgrid-cell {
            word-wrap: break-word;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="images/genesys.png" width="30" height="30" class="d-inline-block align-top" alt="">
            Cloud Competency Center Request Form
        </a>
        <a href="./index.html" class="admin btn btn-primary">Submit a new Request</a>
    </nav>

    <div class="col-12 admin">
        <div id="basicgrid"></div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="title" class="modal-title">Request</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form class="modal-body form-horizontal" id="modal-form">
                    <div class="form-group">

                        <form id="modal-form">
                            <div class="form-row">
                                <div class="form-group col-md-5">
                                    <label for="region">Region</label>
                                    <select id="region" name="region" class="form-control" required>
                                        <option value="" disabled selected>Select a Region</option>
                                        <option value="APAC">APAC</option>
                                        <option value="EMEA">EMEA</option>
                                        <option value="LATAM">LATAM</option>
                                        <option value="NA">North America</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-5">
                                    <label for="subRegion">Sub-Region</label>
                                    <select id="subRegion" name="subRegion" class="form-control" required>
                                        <option value="" disabled selected>Select a Sub-Region</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-5">
                                    <label for="product">Product</label>
                                    <select id="product" name="product" class="form-control" required>
                                        <option value="" disabled selected>Select a Product</option>
                                        <option value="Genesys Cloud">Genesys Cloud</option>
                                        <option value="Genesys Engage">Genesys Engage</option>
                                        <option value="Genesys Engage Cloud">Genesys Engage Cloud</option>
                                        <option value="PureConnect">PureConnect</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-5">
                                    <label for="requestType">Request Type</label>
                                    <select id="requestType" name="requestType" class="form-control" required>
                                        <option value="" disabled selected>Select a Request Type</option>
                                        <option value="Additional Privacy Support">Additional Privacy Support</option>
                                        <option value="Additional Security Support">Additional Security Support</option>
                                        <option value="Associate SC & AE Enablement">Associate SC & AE Enablement</option>
                                        <option value="Cloud Migrations">Cloud Migrations</option>
                                        <option value="Critical Situation Management">Critical Situation Management</option>
                                        <option value="End to End Partner Enablement">End to End Partner Enablement</option>
                                        <option value="Innovation (Custom Demos, Integrations, Beta Testing)">Innovation (Custom
                                            Demos,
                                            Integrations, Beta Testing)</option>
                                        <option value="Must Win/Strategic Opportunity Support">Must Win/Strategic Opportunity
                                            Support
                                        </option>
                                        <option value="Partner Enablement">Partner Enablement (Summits/Events/Webinars)</option>
                                        <option value="POCs & Pilots for Strategic Opportunities">POCs & Pilots for Strategic
                                            Opportunities</option>
                                        <option value="Technical Design/Architecture Review">Technical Design/Architecture
                                            Review
                                        </option>
                                        <option value="Test Drive">Test Drive</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-5">
                                    <label for="requesterName">Requester Name</label>
                                    <input type="text" class="form-control" id="requesterName" name="requesterName" placeholder="Your Name" required>
                                </div>
                                <div class="form-group col-md-5">
                                    <label for="requesterEmail">Requester Email</label>
                                    <input type="text" class="form-control" id="requesterEmail" name="requesterEmail" placeholder="Your Email Address" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-5">
                                    <label for="requesterPhoneNumber">Requester Phone #</label>
                                    <input type="text" class="form-control" id="requesterPhoneNumber" name="requesterPhoneNumber" placeholder="Your Phone Number" required>
                                </div>
                                <div class="form-group col-md-5">
                                    <label for="datetimepicker1">Need Completed By</label>
                                    <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                                        <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
                                            <div class="input-group-text"><em class="fa fa-calendar"></em></div>
                                        </div>
                                        <input type="text" class="form-control datetimepicker-input" data-target="#datetimepicker1" required />
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-10">
                                    <label for="description">Description</label>
                                    <textarea class="form-control" id="description" name="description" placeholder="Describe your request" required></textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-10">
                                    <label for="partnerCustomerName">Partner and/or Customer Name</label>
                                    <input type="text" class="form-control" id="partnerCustomerName" name="partnerCustomerName" placeholder="Partner and/or Customer Name" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-10">
                                    <label for="salesforceAccountOpportunity">Salesforce Account / Opportunity URL</label>
                                    <input type="text" class="form-control" id="salesforceAccountOpportunity" name="salesforceAccountOpportunity" placeholder="Link to Salesforce opportunity or account" required>
                                </div>
                            </div>
                        </form>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button id="submit" type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>>
            </div>
        </div>
    </div>


    <noscript>You need to enable JavaScript to run this app.</noscript>
    <!-- Bootstrap core JavaScript-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <!-- Core plugin JavaScript-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
    <!-- Bootstrap Date/Time Picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>
    <!-- Genesys Cloud -->
    <script src="https://sdk-cdn.mypurecloud.com/javascript/61.0.0/purecloud-platform-client-v2.min.js"></script>
    <!-- Editable -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
    <!-- JQuery Validate -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.1/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.1/dist/additional-methods.min.js"></script>
    <!-- jQuery Toast -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>
    <!-- Our Scripts -->
    <script src="js/gc.js"></script>
    <script src="js/requests.js"></script>
    <script src="js/tools.js"></script>

    <script>

        let regions = {
            APAC: [
                "Asia", "Australia", "New Zeland"
            ],
            EMEA: [
                "Central", "North", "South"
            ],
            LATAM: [
                "Andean", "Brazil", "Mexico", "Southern-Cone"
            ],
            NA: [
                "Central", "Eastern", "Western"
            ]
        }

        let region = getUrlParameter("region");
        console.log('Region:', region);

        var requests = {
            loadData: function (filter) {
                return $.grep(this.requests, function (request) {
                    return (!filter.requesterName || request.requesterName.indexOf(filter.requesterName) > -1)
                        && (!filter.product || request.product.indexOf(filter.product) > -1)
                        && (!filter.partnerCustomerName || request.partnerCustomerName.indexOf(filter.partnerCustomerName) > -1)
                        && (!filter.partnerCustomerName || request.partnerCustomerName.indexOf(filter.partnerCustomerName) > -1)
                        && (!filter.partnerCustomerName || request.partnerCustomerName.indexOf(filter.partnerCustomerName) > -1)
                        && (!filter.partnerCustomerName || request.partnerCustomerName.indexOf(filter.partnerCustomerName) > -1)
                        && (!filter.requesterEmail || request.requesterEmail.indexOf(filter.requesterEmail) > -1);
                });
            },
            updateItem: function (updatingRequest) { },
            deleteItem: function (deletingRequest) {
                var requestIndex = $.inArray(deletingRequest, this.requests);
                this.requests.splice(requestIndex, 1);
            }
        }

        init();
        async function init() {
            var userInfo = await getMe();

            try {
                requests.requests = await getRequests(region)
                console.log(requests.requests);
                window.requests = requests;
                loadRequests();
            } catch (error) {
                console.error(error);
            }
        }

        function initModal() {
            $("#editModal #region").val("");
            $("#editModal #region").change();
            $("#editModal #subRegion").val("");
            $("#editModal #product").val("");
            $("#editModal #requestType").val("");
            $("#editModal #requesterName").val("");
            $("#editModal #requesterEmail").val("");
            $("#editModal #requesterPhoneNumber").val("");
            $("#editModal #datetimepicker1").datetimepicker("clear");
            $("#editModal #description").val("");
            $("#editModal #partnerCustomerName").val("");
            $("#editModal #salesforceAccountOpportunity").val("");
        }

        function loadRequests() {
            console.log('Showing requests...');
            try {

                jsGrid.setDefaults({ tableClass: "jsgrid-table table table-striped table-hover" });
                jsGrid.setDefaults("text", {
                    _createTextBox: function () {
                        return $("<input>").attr("type", "text").attr("class", "form-control input-sm")
                    }
                });
                jsGrid.setDefaults("number", {
                    _createTextBox: function () {
                        return $("<input>").attr("type", "number").attr("class", "form-control input-sm")
                    }
                });
                jsGrid.setDefaults("textarea", {
                    _createTextBox: function () {
                        return $("<input>").attr("type", "textarea").attr("class", "form-control")
                    }
                });
                jsGrid.setDefaults("control", {
                    _createGridButton: function (cls, tooltip, clickHandler) {
                        var grid = this._grid;
                        return $("<button>").addClass(this.buttonClass).addClass(cls).attr({
                            type: "button",
                            title: tooltip
                        }).on("click", function (e) {
                            clickHandler(grid, e)
                        })
                    }
                });
                jsGrid.setDefaults("select", {
                    _createSelect: function () {
                        var $result = $("<select>").attr("class", "form-control input-sm"),
                            valueField = this.valueField,
                            textField = this.textField,
                            selectedIndex = this.selectedIndex;
                        return $.each(this.items, function (index, item) {
                            var value = valueField ? item[valueField] : index,
                                text = textField ? item[textField] : item,
                                $option = $("<option>").attr("value", value).text(text).appendTo($result);
                            $option.prop("selected", selectedIndex === index)
                        }), $result
                    }
                });

                $("#basicgrid").jsGrid({
                    height: "100vh",
                    width: "100%",
                    filtering: true,
                    editing: false,
                    sorting: true,
                    paging: true,
                    autoload: true,
                    pageSize: 25,
                    pageButtonCount: 5,
                    loadIndication: true,
                    loadIndicationDelay: 500,
                    loadMessage: "Loading...",
                    loadShading: true,
                    deleteConfirm: "Do you really want to delete this request?",
                    rowClick: function (args) {
                        showModal(args.item);
                    },
                    deleteItem: function (deletingRequest) {
                        console.log('Deleting:', deletingRequest);
                        //deleteRequest(deletingRequest.id);
                    },
                    controller: requests,
                    noDataContent: "No Requests",
                    fields: [{
                        name: "region",
                        title: "Region",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "subRegion",
                        title: "Sub-Region",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "product",
                        title: "Product",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "requestType",
                        title: "Request Type",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "requesterName",
                        title: "Requester Name",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "requesterEmail",
                        title: "Requester Email",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "requesterPhoneNumber",
                        title: "Requester Phone #",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "needCompletedBy",
                        title: "Need Completed By",
                        type: "text",
                        itemTemplate: function (value, item) {
                            return `${moment(value).fromNow()} (${moment(value).calendar()})`;
                        },
                        width: "auto"
                    }, {
                        name: "description",
                        title: "Description",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "partnerCustomerName",
                        title: "Partner or Customer Name",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "salesforceAccountOpportunity",
                        title: "SF Account or Opportunity",
                        type: "text",
                        itemTemplate: function (value, item) {
                            return `<a href="${value}" target="_blank">${value}</a>`;
                        },
                        width: "auto"
                    }, {
                        name: "createdAt",
                        title: "Created",
                        type: "text",
                        itemTemplate: function (value, item) {
                            return moment(value).fromNow();
                        },
                        width: "auto"
                    }, {
                        name: "updatedAt",
                        title: "Last Updated",
                        type: "text",
                        itemTemplate: function (value, item) {
                            return moment(value).fromNow();
                        },
                        width: "auto"
                    }, {
                        type: "control",
                        editButton: false
                    }]
                });
            } catch (error) {
                console.error(error);
            }
        }

        function showModal(request) {
            console.log("Showing modal for:", request);
            $("#editModal #region").val(request.region);
            $("#editModal #region").change();
            $("#editModal #subRegion").val(request.subRegion);
            $("#editModal #product").val(request.product);
            $("#editModal #requestType").val(request.requestType);
            $("#editModal #requesterName").val(request.requesterName);
            $("#editModal #requesterEmail").val(request.requesterEmail);
            $("#editModal #requesterPhoneNumber").val(request.requesterPhoneNumber);
            $("#editModal #datetimepicker1").datetimepicker({
                date: new Date(request.needCompletedBy),
                format: 'L'
            });
            $("#editModal #description").val(request.description);
            $("#editModal #partnerCustomerName").val(request.partnerCustomerName);
            $("#editModal #salesforceAccountOpportunity").val(request.salesforceAccountOpportunity);

            $("#editModal").modal("show");
        }

        $("#editModal #region").on("change", () => {
            $("#editModal #subRegion").empty();
            if (!$("#editModal #region").val()) return;
            for (let subregion of regions[$("#editModal #region").val()]) {
                $("<option/>", { value: subregion }).text(subregion).appendTo("#editModal #subRegion");
            }
        });

        $('#editModal').on('shown.bs.modal', (e) => {
        });

        $('#editModal').on('hidden.bs.modal', async () => {
            $("#basicgrid").empty();
            init();
            initModal();
        });

        $("#editModal #submit").on("click", async (e) => {
            e.preventDefault();
            if (!$("#modal-form").valid()) {
                showMessage("Missing or invalid fields", true);
                return;
            }

            //TODO Save request (PATCH /requests/{id})
        });

        function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
        };

    </script>

</body>

</html>