<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>CCC Request Form</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- Bootstrap Date/Time Picker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/css/tempusdominus-bootstrap-4.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Editable CSS -->
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" /> <!-- Custom CSS -->
    <style>
        /* .jsgrid-cell {
            overflow: hidden;
        } */
        .jsgrid-cell {
            word-wrap: break-word;
        }
    </style>
</head>

<body>

    <div class="col-12 admin">
        <div id="basicgrid"></div>
    </div>

    <noscript>You need to enable JavaScript to run this app.</noscript>
    <!-- Bootstrap core JavaScript-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <!-- Core plugin JavaScript-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
    <!-- Bootstrap Date/Time Picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>
    <!-- Genesys Cloud -->
    <script src="https://sdk-cdn.mypurecloud.com/javascript/61.0.0/purecloud-platform-client-v2.min.js"></script>
    <!-- Editable -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
    <!-- Our Scripts -->
    <script src="js/gc.js"></script>
    <script src="js/requests.js"></script>

    <script>

        let regions = {
            APAC: [
                "Asia", "Australia", "New Zeland"
            ],
            EMEA: [
                "Central", "North", "South"
            ],
            LATAM: [
                "Andean", "Brazil", "Mexico", "Southern-Cone"
            ],
            NA: [
                "Central", "Eastern", "Western"
            ]
        }

        let adminGroups = [
            "4bfbc98d-35d6-4a85-85f9-4e661c1a32c0"
        ]

        var requests = {
            loadData: function (filter) {
                return $.grep(this.requests, function (request) {
                    return (!filter.requesterName || request.requesterName.indexOf(filter.requesterName) > -1)
                        && (!filter.product || request.product.indexOf(filter.product) > -1)
                        && (!filter.partnerCustomerName || request.partnerCustomerName.indexOf(filter.partnerCustomerName) > -1)
                        && (!filter.partnerCustomerName || request.partnerCustomerName.indexOf(filter.partnerCustomerName) > -1)
                        && (!filter.partnerCustomerName || request.partnerCustomerName.indexOf(filter.partnerCustomerName) > -1)
                        && (!filter.partnerCustomerName || request.partnerCustomerName.indexOf(filter.partnerCustomerName) > -1)
                        && (!filter.requesterEmail || request.requesterEmail.indexOf(filter.requesterEmail) > -1);
                });
            },
            updateItem: function (updatingRequest) { },
            deleteItem: function (deletingRequest) {
                var requestIndex = $.inArray(deletingRequest, this.requests);
                this.requests.splice(requestIndex, 1);
            }
        }

        init();
        async function init() {
            var userInfo = await getMe();

            // Show Admin fields?
            if (userInfo.groups.some(g => adminGroups.includes(g))) {
                $(".admin").show();
            } else {
                $(".admin").hide();
            }

            try {
                requests.requests = await getRequests()
                console.log(requests.requests);
                window.requests = requests;
                showRequests();
            } catch (error) {
                console.error(error);
            }
        }

        function showRequests() {
            console.log('Showing requests...');
            try {

                jsGrid.setDefaults({ tableClass: "jsgrid-table table table-striped table-hover" });
                jsGrid.setDefaults("text", {
                    _createTextBox: function () {
                        return $("<input>").attr("type", "text").attr("class", "form-control input-sm")
                    }
                });
                jsGrid.setDefaults("number", {
                    _createTextBox: function () {
                        return $("<input>").attr("type", "number").attr("class", "form-control input-sm")
                    }
                });
                jsGrid.setDefaults("textarea", {
                    _createTextBox: function () {
                        return $("<input>").attr("type", "textarea").attr("class", "form-control")
                    }
                });
                jsGrid.setDefaults("control", {
                    _createGridButton: function (cls, tooltip, clickHandler) {
                        var grid = this._grid;
                        return $("<button>").addClass(this.buttonClass).addClass(cls).attr({
                            type: "button",
                            title: tooltip
                        }).on("click", function (e) {
                            clickHandler(grid, e)
                        })
                    }
                });
                jsGrid.setDefaults("select", {
                    _createSelect: function () {
                        var $result = $("<select>").attr("class", "form-control input-sm"),
                            valueField = this.valueField,
                            textField = this.textField,
                            selectedIndex = this.selectedIndex;
                        return $.each(this.items, function (index, item) {
                            var value = valueField ? item[valueField] : index,
                                text = textField ? item[textField] : item,
                                $option = $("<option>").attr("value", value).text(text).appendTo($result);
                            $option.prop("selected", selectedIndex === index)
                        }), $result
                    }
                });

                $("#basicgrid").jsGrid({
                    height: "100vh",
                    width: "100%",
                    filtering: true,
                    editing: true,
                    sorting: true,
                    paging: true,
                    autoload: true,
                    pageSize: 25,
                    pageButtonCount: 5,
                    loadIndication: true,
                    loadIndicationDelay: 500,
                    loadMessage: "Loading...",
                    loadShading: true,
                    deleteConfirm: "Do you really want to delete this request?",
                    controller: requests,
                    noDataContent: "No Requests",
                    fields: [{
                        name: "region",
                        title: "Region",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "subRegion",
                        title: "Sub-Region",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "product",
                        title: "Product",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "requestType",
                        title: "Request Type",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "requesterName",
                        title: "Requester Name",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "requesterEmail",
                        title: "Requester Email",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "requesterPhoneNumber",
                        title: "Requester Phone #",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "needCompletedBy",
                        title: "Need Completed By",
                        type: "text",
                        itemTemplate: function (value, item) {
                            return `${moment(value).fromNow()} (${moment(value).calendar()})`;
                        },
                        width: "auto"
                    }, {
                        name: "description",
                        title: "Description",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "partnerCustomerName",
                        title: "Partner or Customer Name",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "salesforceAccountOpportunity",
                        title: "SF Account or Opportunity",
                        type: "text",
                        itemTemplate: function (value, item) {
                            return `<a href="${value}" target="_blank">${value}</a>`;
                        },
                        width: "auto"
                    }, {
                        name: "fileAttachments",
                        title: "File Attachments",
                        type: "text",
                        width: "auto"
                    }, {
                        name: "createdAt",
                        title: "Created",
                        type: "text",
                        itemTemplate: function (value, item) {
                            return moment(value).fromNow();
                        },
                        width: "auto"
                    }, {
                        name: "updatedAt",
                        title: "Last Updated",
                        type: "text",
                        itemTemplate: function (value, item) {
                            return moment(value).fromNow();
                        },
                        width: "auto"
                    }, {
                        type: "control",
                        editButton: true
                    }]
                });
            } catch (error) {
                console.error(error);
            }
        }



    </script>

</body>

</html>