<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>Document</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alasql"></script>
    <script src="https://chartjs-plugin-datalabels.netlify.com/chartjs-plugin-datalabels.js"></script>
    <script src="js/requests.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>

</head>

<body>

    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="images/genesys.png" width="30" height="30" class="d-inline-block align-top" alt="">
            Competence Center Dashboard

        </a>

        <a href="./requests.html" id="reviewRequestsButton" class="admin btn btn-primary">Review Requests</a>
    </nav>


    <div class="container-fluid">
        <br>
        <div class="form-row">
            <div class="form-group col-sm-12">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="region">Region</label>
                        <select id="region" name="region" class="form-control">
                            <option value="" selected>All regions</option>
                            <option value="APAC">APAC</option>
                            <option value="EMEA">EMEA</option>
                            <option value="LATAM">LATAM</option>
                            <option value="NA">North America</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="product">Product</label>
                        <select id="product" name="product" class="form-control">
                            <option value="" selected>All products</option>
                            <option value="Genesys Cloud">Genesys Cloud</option>
                            <option value="Genesys Engage">Genesys Engage</option>
                            <option value="Genesys Engage Cloud">Genesys Engage Cloud</option>
                            <option value="PureConnect">PureConnect</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="segment">Market Segment</label>
                        <select id="segment" name="segment" class="form-control">
                            <option value="" selected>All</option>
                            <option value="Mid-market">Mid-market</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Enterprise">Enterprise</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <div class="chart-container" style="width:35vw" id="chart_region_container" name="requests">
                            <canvas id="chart_region"></canvas>
                        </div>
                    </div>

                    <div class="form-group col-md-4">
                        <div class="chart-container" style="width:35vw" id="chart_product_container" name="product">
                            <canvas id="chart_product"></canvas>
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <div class="chart-container" style="width:35vw" id="chart_segment_container" name="segment">
                            <canvas id="chart_segment"></canvas>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <div class="chart-container" style="width:40vw" id="chart_status_container" name="status">
                            <canvas id="chart_status"></canvas>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <div class="chart-container" style="width:40vw" id="chart_requestCategory_container" name="requestCategory">
                            <canvas id="chart_requestCategory"></canvas>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-12">
                        <div class="chart-container" style="width:90vw" id="chart_requestType_container" name="requestType">
                            <canvas id="chart_requestType"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button onclick="exportData();" class="admin btn btn-dark" style="float: right;">Export to CSV</button>
        <br><br><br>
    </div>

    <script>
        let gcToken = localStorage.getItem("gcToken");
        let data;
        let region = getUrlParameter("region");
        $("#region").val(region);


        // SetLink for review Requests
        document.getElementById("reviewRequestsButton").setAttribute("href", `./requests.html?region=${region}`);

        function prepareDataForSQL(_sql, _data) {
            //console.log(`prepareDataForSQL: ${_sql}`);
            let res = alasql(_sql, [_data]);

            let labels = [];
            let values = [];
            res.forEach(element => {
                labels.push(element.label);
                values.push(element.val);
            });

            let myData = {
                labels: labels,
                datasets: [{
                    data: values,
                    label: "All",
                    backgroundColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 100, 64, 1)',
                        'rgba(200, 109, 164, 1)',
                        'rgba(255, 50, 99, 1)',
                        'rgba(100, 30, 164, 1)',
                        'rgba(200, 159, 255, 1)',
                        'rgba(50, 100, 200, 1)',
                        'rgba(70, 150, 76, 1)',
                        'rgba(20, 255, 150, 1)',
                        'rgba(250, 50, 40, 1)',
                        'rgba(175, 55, 55, 1)',
                        'rgba(240, 140, 40, 1)',
                        'rgba(66, 66, 166, 1)'
                    ]
                }]
            };

            return myData
        }

        init();

        $("#region").on("change", () => {
            init();
        });
        $("#product").on("change", () => {
            init();
        });
        $("#segment").on("change", () => {
            init();
        });


        function buildFilter(_sql, _isWHERE) {
            var filter = "";
            var bAND = false;
            var bEmpty = true;

            if (!_isWHERE)
                filter = "WHERE ("
            else
                filter = " AND "


            if ($('#region').val() != "" || $('#product').val() != "" || $('#segment').val() != "") {
                if ($('#region').val() != "") {
                    filter = filter + ` region = '${$('#region').val()}' `
                    bAND = true;
                    bEmpty = false;
                }

                if ($('#product').val() != "") {
                    if (bAND) filter = filter + " AND ";
                    filter = filter + `product = '${$('#product').val()}' `;
                    bEmpty = false;
                    bAND = true;
                }

                if ($('#segment').val() != "") {
                    if (bAND) filter = filter + " AND ";
                    filter = filter + `segment = '${$('#segment').val()}' `;
                    bEmpty = false;
                }

            }
            if (!_isWHERE) filter = filter + ")";
            if (bEmpty) {
                _sql = _sql.replace('##', "");
            } else
                _sql = _sql.replace('##', filter);

            return _sql
        }

        function makeChart(_sql, _isWHERE, _chartName, _chartType, _chartTitle, _data) {

            let sql = buildFilter(_sql, _isWHERE);
            console.log(sql);

            $(`#chart_${_chartName}`).remove();
            $(`#chart_${_chartName}_container`).append(`<canvas id="chart_${_chartName}"><canvas>`);

            let scales;
            if (_chartType == "bar" || _chartType == "horizontalBar") {
                scales = {
                    yAxes: [{
                        ticks: {
                            min: 0

                        }

                    }],
                    xAxes: [{
                        ticks: {
                            min: 0

                        }

                    }]
                }
            }


            var ctx = document.getElementById(`chart_${_chartName}`)
            var myDoughnutChart = new Chart(ctx, {
                type: _chartType,
                data: prepareDataForSQL(sql, _data),
                options: {
                    title: {
                        display: true,
                        text: _chartTitle
                    }, plugins: {
                        datalabels: {
                            color: 'black',
                            align: 'center',
                            clamp: true

                        }
                    }, scales: scales
                }
            });



        }


        async function init() {
            
            try {
                data = await getDashboard(gcToken);
            } catch (error) {
                if (error.status == 401) {
                    window.open('https://pierricki3.github.io/CCCRequestsForm/index.html', "_self");
                }
            }

            // Parse Tasks
            let task_filter = buildFilter('SELECT tasks FROM ? ##', false);
            let task_raw = alasql(task_filter, [data]);
            let task_parsed = []; // Tasks with Time
            task_raw.forEach(function (aItem) {
                if (aItem.tasks && aItem.tasks.length > 0) {
                    aItem.tasks.forEach(function (aTask) {
                        task_parsed.push(aTask);
                    })
                }
            });


            // ByRegion
            makeChart('SELECT count(*) as val, region as label FROM ? ## GROUP BY region', false, 'region', 'doughnut', 'Requests', data);
            // BySegement
            makeChart('SELECT count(*) as val, segment as label FROM ? ## GROUP BY segment', false, 'segment', 'doughnut', 'By Segment', data);

            // By Product
            makeChart('SELECT count(*) as val, product as label FROM ? ## GROUP BY product', false, 'product', 'pie', 'By Product', data);
            // By Status for Active and not Delted
            makeChart("SELECT count(*) as val, status as label FROM ? WHERE (isDeleted = false AND status <> 'Closed' ##) GROUP BY status", true, 'status', 'pie', 'By status for active requests', data);



            // By Request Category / Time

            let res = alasql('SELECT count(*) as val, taskCategory as label FROM ? GROUP BY taskCategory', [task_parsed]);
            var labels = [];
            var values1 = [];
            res.forEach(element => {
                labels.push(element.label);
                values1.push(element.val);
            });

            res = alasql('SELECT SUM(taskTime::NUMBER) as val, taskCategory as label FROM ? GROUP BY taskCategory', [task_parsed]);
            var values2 = [];
            res.forEach(element => {
                values2.push(element.val);
            });


            $('#chart_requestCategory').remove();
            $('#chart_requestCategory_container').append('<canvas id="chart_requestCategory"><canvas>');

            var ctx = document.getElementById(`chart_requestCategory`)
            var myDoughnutChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        data: values1,
                        label: "Requests",
                        backgroundColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 100, 64, 1)',
                            'rgba(200, 109, 164, 1)',
                            'rgba(255, 50, 99, 1)',
                            'rgba(100, 30, 164, 1)',
                            'rgba(200, 159, 255, 1)',
                            'rgba(50, 100, 200, 1)',
                            'rgba(70, 150, 76, 1)',
                            'rgba(20, 255, 150, 1)',
                            'rgba(250, 50, 40, 1)',
                            'rgba(175, 55, 55, 1)',
                            'rgba(240, 140, 40, 1)',
                            'rgba(66, 66, 166, 1)'
                        ]
                    }, {
                        type: 'line',
                        data: values2,
                        label: "Time spent",
                        backgroundColor: [
                            'rgba(70, 128, 215, 0.3)'
                        ],
                        borderWidth: 0
                    }],
                    labels: labels
                },
                options: {
                    title: {
                        display: true,
                        text: "RequestCategory / Time spent"
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0

                            }

                        }],
                        xAxes: [{
                            ticks: {
                                min: 0

                            }

                        }]
                    }
                }
            });

            // By RequestType (a'ka taskType)
            makeChart("SELECT count(*) as val, taskType as label FROM ? WHERE (taskType <> 'undefined') GROUP BY taskType", false, 'requestType', 'bar', 'By task Type', task_parsed);

        }


        async function exportData() {

            let exportRegion = $('#region').val() == "" ? undefined : $('#region').val();
            let exportProduct = $('#product').val() == "" ? undefined : $('#product').val();
            let exportSegment = $('#segment').val() == "" ? undefined : $('#segment').val();
            let myExportData;
            try {
                myExportData = await getExport(exportRegion, exportProduct, exportSegment, gcToken);
                if (myExportData.length == 0)
                    return



                var flatData = [];
                myExportData.forEach(function (aItem) {
                    aItem.tasks.forEach(function (aTask) {
                        var singleRow = $.extend(true, {}, aItem);
                        singleRow.taskCategory = aTask.taskCategory;
                        singleRow.taskType = aTask.taskType;
                        singleRow.taskTime = aTask.taskTime;
                        delete singleRow.tasks
                        if (singleRow.mailDistibution) delete singleRow.mailDistibution;
                        singleRow.createdAt = moment.utc(singleRow.createdAt)
                        singleRow.updatedAt = moment.utc(singleRow.updatedAt)
                        flatData.push(singleRow);

                    });

                })

                myExportData = {};

                const replacer = (key, value) => value === null ? '' : value // specify how you want to handle null values here
                const header = Object.keys(flatData[0])
                let csv = flatData.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(';'))
                csv.unshift(header.join(';'))
                csv = csv.join('\r\n')

                download(csv, 'export.csv');
            } catch (error) {
                console.log(error);
                if (error.status == 401) {
                    window.open('https://pierricki3.github.io/CCCRequestsForm/index.html', "_self");
                }

            }

        }

        // Function to download data to a file
        function download(data, filename, type) {
            var file = new Blob([data], { type: type });
            if (window.navigator.msSaveOrOpenBlob) // IE10+
                window.navigator.msSaveOrOpenBlob(file, filename);
            else { // Others
                var a = document.createElement("a"),
                    url = URL.createObjectURL(file);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function () {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
        }


        function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
        };

    </script>



</body>

</html>